<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publications</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="css/style.css">

<style>
#homeBtn { position: fixed; top: 20px; left: 20px; font-size: 24px; cursor: pointer; color: #0054a6; z-index: 1000; }
.main-grid { display: flex; gap: 20px; padding: 60px 20px 20px 20px; flex-wrap: wrap; }
.left-panel, .right-panel { background: white; padding: 20px; border-radius: 10px; }
.left-panel { flex: 1; min-width: 300px; }
.right-panel { flex: 1; min-width: 300px; }
.chart-container { width: 100%; margin-bottom: 20px; }
#projectDetail { display: none; margin-top: 20px; }
#showAllBtn { margin-bottom: 10px; cursor: pointer; color: #0054a6; font-weight: bold; }
.clickable-row:hover { background-color: #e6f0ff; cursor: pointer; }
.highlighted { background-color: #cce0ff !important; }
@media(max-width: 900px) { .main-grid { flex-direction: column; } }
</style>
</head>
<body>

<div id="homeBtn">üè†</div>
<h1>Publications</h1>

<div class="main-grid">
  <div class="left-panel">
    <h2>Publications</h2>
    <div id="showAllBtn">üîÑ Show All Publications</div>
    <table id="publicationsTable" class="display" style="width:100%;">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="right-panel">
    <div id="chartContainer">
      <h2>Publications per Year</h2>
      <div class="chart-container">
        <canvas id="chartPublications"></canvas>
      </div>
    </div>

    <div id="projectDetail">
      <h2>Publication Details</h2>
      <div id="detailContent"></div>
    </div>
  </div>
</div>

<script src="js/libs.js"></script>
<script src="js/sources.js"></script>
<script>
window.addEventListener('load', () => {
  Papa.parse(CSV_SOURCES.publications, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {

      const rawData = results.data.filter(r => Object.values(r).some(v => v));
      if (!rawData.length) return;

      // Columns to show in table
      const visibleCols = ["Year", "Publication Title", "Source / Publisher"];
      const yearCol = "Year";
      let dataTable = null;
      let currentData = [...rawData];

      function isLink(value) {
        return /^https?:\/\/\S+$/i.test(value);
      }

      const buildTable = (data) => {
        currentData = data;

        const $table = $("#publicationsTable");
        $table.find("thead").html("<tr>" + visibleCols.map(h => `<th>${h}</th>`).join("") + "</tr>");

        let tbody = "";
        data.forEach((row, idx) => {
          tbody += `<tr class="clickable-row" data-index="${idx}">` +
            visibleCols.map(h => {
              const val = row[h] || '';
              return `<td>${isLink(val) ? `<a href="${val}" target="_blank">${val} üîó</a>` : val}</td>`;
            }).join("") +
          `</tr>`;
        });
        $table.find("tbody").html(tbody);

        if(dataTable) dataTable.destroy();
        dataTable = $table.DataTable({ scrollX:true, pageLength:10 });
      };

      buildTable(rawData);

      // Chart
      const countPerYear = {};
      rawData.forEach(r => {
        const year = r[yearCol];
        if(!year) return;
        countPerYear[year] = (countPerYear[year] || 0) + 1;
      });

      const years = Object.keys(countPerYear).sort();
      const counts = years.map(y => countPerYear[y]);

      const ctx = document.getElementById("chartPublications").getContext("2d");
      const chart = new Chart(ctx, {
        type: "bar",
        data: { labels: years, datasets:[{label:"Publications", data:counts, backgroundColor:"#2ca02c"}] },
        options: {
          responsive:true,
          plugins:{legend:{position:"top"}},
          scales:{y:{beginAtZero:true, precision:0}},
          onClick: (evt, elements) => {
            if(elements.length){
              const idx = elements[0].index;
              const selectedYear = years[idx];
              buildTable(rawData.filter(r => r[yearCol] === selectedYear));
            }
          }
        }
      });

      // Show All button
      $('#showAllBtn').on('click', () => buildTable(rawData));

      // Row click ‚Üí Details
      $(document).off('click', '.clickable-row');
      $(document).on('click', '.clickable-row', function(){
        const idx = $(this).data('index');
        const record = currentData[idx];

        $('.clickable-row').removeClass('highlighted');
        $(this).addClass('highlighted');

        let contentHtml = "<ul>";
        visibleCols.forEach(h => {
          const val = record[h] || '';
          contentHtml += `<li><strong>${h}:</strong> ${isLink(val) ? `<a href="${val}" target="_blank">${val} üîó</a>` : val}</li>`;
        });
        contentHtml += "</ul>";

        $('#detailContent').html(contentHtml);
        $('#projectDetail').fadeIn();
        $('html, body').animate({ scrollTop: $('#chartContainer').offset().top }, 500);
      });

      $('#homeBtn').on('click',()=>{ window.location.href='index.html'; });
    }
  });
});
</script>
</body>
</html>

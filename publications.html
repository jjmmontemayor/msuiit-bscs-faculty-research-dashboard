<script>
window.addEventListener('load', () => {
  Papa.parse(CSV_SOURCES.publications, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const rawData = results.data.filter(r => Object.values(r).some(v => v));
      if (!rawData.length) return;

      const allHeaders = Object.keys(rawData[0]);
      const tableCols = [allHeaders[0], allHeaders[1]]; // A, B

      // Build table
      const $table = $("#publicationsTable");
      $table.find("thead").html("<tr>" + tableCols.map(h => `<th>${h}</th>`).join("") + "</tr>");
      let tbody = "";
      rawData.forEach((row, idx) => {
        tbody += "<tr class='clickable-row' data-index='"+idx+"'>" +
                  tableCols.map(h => `<td>${row[h] || ""}</td>`).join("") +
                 "</tr>";
      });
      $table.find("tbody").html(tbody);
      const dataTable = $table.DataTable({scrollX:true, pageLength:10});

      // Chart: count per year (column A)
      const yearCol = allHeaders[0];
      const countPerYear = {};
      rawData.forEach(r => {
        const year = r[yearCol];
        if(!year) return;
        if(!countPerYear[year]) countPerYear[year] = 0;
        countPerYear[year]++;
      });

      const years = Object.keys(countPerYear).sort();
      const counts = years.map(y => countPerYear[y]);

      const chartPublications = new Chart(document.getElementById("chartPublications"), {
        type: "bar",
        data: { labels: years, datasets:[{label:"Publications", data:counts, backgroundColor:"#2ca02c"}]},
        options: {
          responsive:true,
          plugins:{legend:{position:"top"}},
          scales:{y:{beginAtZero:true, precision:0}}
        }
      });

      // Row click for details
      $(document).on('click','.clickable-row', function(){
        const rowIdx = $(this).data('index');
        const project = rawData[rowIdx];

        $('.clickable-row').removeClass('highlighted');
        $(this).addClass('highlighted');

        // Image preview (top of details)
        const linkVal = project[allHeaders[1]] || '';
        let imgHtml = '';
        if(linkVal && linkVal.startsWith('http')) {
          imgHtml = `<div style="text-align:center;margin-bottom:10px;">
                       <img src="${linkVal}" alt="Preview" style="max-width:100%; max-height:300px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.3);">
                     </div>`;
        }

        let contentHtml = "<ul>";
        allHeaders.forEach(h=>{
          contentHtml += `<li><strong>${h}:</strong> ${project[h]||''}</li>`;
        });
        contentHtml += "</ul>";

        $('#detailContent').html(imgHtml + contentHtml);
        $('#projectDetail').fadeIn();
        $('html, body').animate({ scrollTop: $('#chartContainer').offset().top }, 500);
      });

      // Home button
      $('#homeBtn').on('click',()=>{ window.location.href='index.html'; });
    }
  });
});
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSU-IIT CS Faculty Research and Creativity Dashboard</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }
    h1, h2, h3 {
      text-align: center;
    }
    .stats-grid {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #0054a6;
      color: white;
      padding: 20px;
      margin: 10px;
      border-radius: 8px;
      flex: 1 1 180px;
      text-align: center;
    }
    .chart-container {
      width: 90%;
      margin: 30px auto;
    }
    table.dataTable {
      background: white;
      width: 90%;
      margin: 20px auto;
    }
  </style>
</head>
<body>

<h1>CS Research Dashboard</h1>

<section id="stats">
  <h2>Research Statistics</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <span id="internalCount">0</span><br>Internally Funded
    </div>
    <div class="stat-card">
      <span id="externalCount">0</span><br>Externally Funded
    </div>
    <div class="stat-card">
      <span id="pubCount">0</span><br>Publications
    </div>
    <div class="stat-card">
      <span id="confCount">0</span><br>Conferences
    </div>
  </div>

  <div class="chart-container">
    <h3>Research Outputs by Year</h3>
    <canvas id="chartCombined"></canvas>
  </div>
</section>

<section>
  <h2>Faculty Members</h2>
  <table id="facultyTable" class="display">
    <thead></thead>
    <tbody></tbody>
  </table>
</section>

<!-- JS Libraries -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// CSV URLs
const facultyCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-jDPbQ-ZCkBK8_1igyWkHd3ynUPHh5l8eI6KmD-qhpu9ZeYTqYV11X7NQ82NbYyEwvSiTzGVD6-3L/pub?gid=5470856&single=true&output=csv";
const yearlyCSV  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-jDPbQ-ZCkBK8_1igyWkHd3ynUPHh5l8eI6KmD-qhpu9ZeYTqYV11X7NQ82NbYyEwvSiTzGVD6-3L/pub?gid=743932525&single=true&output=csv";

// Load Faculty Table
function loadFacultyTable() {
  Papa.parse(facultyCSV, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data.filter(r => Object.values(r).some(v => v));
      const table = $("#facultyTable");
      const headers = Object.keys(data[0]);
      table.find("thead").html("<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>");
      let tbody = "";
      data.forEach(row => {
        tbody += "<tr>" + headers.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
      });
      table.find("tbody").html(tbody);
      table.DataTable({scrollX: true, pageLength: 10});
    }
  });
}

// Load Statistics + Combined Chart
function loadYearlyStats() {
  Papa.parse(yearlyCSV, {
    download: true,
    header: true,
    complete: function(results) {
      const rows = results.data.filter(r => Object.values(r).some(v => v));

      // Use the first row as the total (sum) row
      const totalRow = rows[0];

      // Update stat cards from total row
      document.getElementById("internalCount").textContent = parseInt(totalRow['Internally Funded Count'] || 0);
      document.getElementById("externalCount").textContent = parseInt(totalRow['Externally Funded Count'] || 0);
      document.getElementById("pubCount").textContent      = parseInt(totalRow['Publications Count'] || 0);
      document.getElementById("confCount").textContent     = parseInt(totalRow['Conferences Count'] || 0);

      // Combined bar chart per year
      const years = [...new Set(rows.map(r => r.Year))].sort();
      const categories = ['Internally Funded','Externally Funded','Publications','Conferences'];

      const datasets = years.map((year, idx) => {
        const row = rows.find(r => r.Year === year);
        const dataPerYear = categories.map(cat => parseInt(row[cat + " Count"] || 0));
        return {
          label: year,
          data: dataPerYear,
          backgroundColor: `hsl(${(idx * 60) % 360}, 70%, 50%)`
        };
      });

      new Chart(document.getElementById('chartCombined'), {
        type: 'bar',
        data: { labels: categories, datasets: datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  });
}

// Initialize
loadFacultyTable();
loadYearlyStats();
</script>
</body>
</html>

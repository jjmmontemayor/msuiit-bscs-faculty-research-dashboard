<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Internally Funded Projects</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="css/style.css">

<style>
.main-grid {
  display: flex;
  gap: 20px;
  padding: 20px;
  flex-wrap: wrap;
  transition: all 0.5s ease;
}

.left-panel, .right-panel {
  background: white;
  padding: 20px;
  border-radius: 10px;
  transition: all 0.5s ease;
}

.left-panel { flex: 1; min-width: 300px; }
.right-panel { flex: 1; min-width: 300px; }

.chart-container { width: 100%; }

#projectDetail {
  display: none;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.fade-in { display: block !important; opacity: 1 !important; }

.clickable-row { cursor: pointer; transition: background 0.2s; }
.clickable-row:hover { background-color: #f0f8ff; }

#backDashboard {
  margin-bottom: 10px;
  display: inline-block;
  padding: 6px 12px;
  background: #0054a6;
  color: white;
  border-radius: 5px;
  text-decoration: none;
}
#backDashboard:hover { background: #003d7a; }

@media(max-width: 900px) { .main-grid { flex-direction: column; } }
</style>
</head>
<body>

<h1>Internally Funded Projects</h1>

<a id="backDashboard" href="index.html">← Back to Dashboard</a>

<div class="main-grid" id="mainGrid">
  <!-- Left: Chart -->
  <div class="left-panel" id="leftPanel">
    <h2>Internally Funded Projects per Year</h2>
    <div class="chart-container">
      <canvas id="internalChart"></canvas>
    </div>
  </div>

  <!-- Right: Table / Details -->
  <div class="right-panel" id="rightPanel">
    <div id="tableContainer">
      <h2>Projects</h2>
      <table id="internalTable" class="display" style="width:100%;">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="projectDetail">
      <button id="backBtn">← Back to Projects</button>
      <h2>Project Details</h2>
      <div id="detailContent"></div>
    </div>
  </div>
</div>

<script src="js/libs.js"></script>
<script src="js/sources.js"></script>

<script>
window.addEventListener('load', () => {
  Papa.parse(CSV_SOURCES.internals, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const rawData = results.data.filter(r => Object.values(r).some(v => v));
      if (!rawData.length) return;

      const allHeaders = Object.keys(rawData[0]);
      const tableCols = [allHeaders[0], allHeaders[1], allHeaders[2]]; // columns A, B, C

      // Build table
      const $table = $("#internalTable");
      $table.find("thead").html("<tr>" + tableCols.map(h => `<th>${h}</th>`).join("") + "</tr>");
      let tbody = "";
      rawData.forEach((row, idx) => {
        tbody += "<tr class='clickable-row' data-index='"+idx+"'>" + tableCols.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
      });
      $table.find("tbody").html(tbody);
      $table.DataTable({scrollX: true, pageLength: 10});

      // Chart: count of projects per year (column A)
      const yearCol = allHeaders[0];
      const countPerYear = {};
      rawData.forEach(r => {
        const year = r[yearCol];
        if(!year) return;
        if(!countPerYear[year]) countPerYear[year] = 0;
        countPerYear[year]++;
      });

      const years = Object.keys(countPerYear).sort();
      const counts = years.map(y => countPerYear[y]);

      const ctx = document.getElementById("internalChart").getContext('2d');
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: years,
          datasets: [{ label: "Internally Funded Projects", data: counts, backgroundColor: "#1f77b4" }]
        },
        options: { responsive: true, plugins: { legend: { position: "top" } }, scales: { y: { beginAtZero: true, precision:0 } } }
      });

      // Click on row → show details and animate chart shrinking
      $(document).on('click', '.clickable-row', function() {
        const rowIdx = $(this).data('index');
        const project = rawData[rowIdx];

        // Animate chart shrinking
        $('#leftPanel').animate({ flex: '0 0 0px', opacity: 0 }, 400);
        $('#tableContainer').fadeOut(200, function() {
          $('#projectDetail').addClass('fade-in');
        });

        let contentHtml = "<ul>";
        allHeaders.forEach(h => { contentHtml += `<li><strong>${h}:</strong> ${project[h] || ''}</li>`; });
        contentHtml += "</ul>";
        $('#detailContent').html(contentHtml);
      });

      // Back to projects → restore chart & table
      $('#backBtn').on('click', () => {
        $('#projectDetail').removeClass('fade-in');
        $('#leftPanel').animate({ flex: '1', opacity: 1 }, 400);
        $('#tableContainer').fadeIn(400);
      });
    }
  });
});
</script>

</body>
</html>

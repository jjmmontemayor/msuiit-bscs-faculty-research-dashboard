<script>
window.addEventListener('load', () => {
  Papa.parse(CSV_SOURCES.internals, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const rawData = results.data.filter(r => Object.values(r).some(v => v));
      if (!rawData.length) return;

      const allHeaders = Object.keys(rawData[0]);
      const displayCols = [allHeaders[0], allHeaders[2], allHeaders[3], allHeaders[4]]; // A, C, D, E

      // Build table
      const $table = $("#internalTable");
      $table.find("thead").html("<tr>" + displayCols.map(h => `<th>${h}</th>`).join("") + "</tr>");
      let tbody = "";
      rawData.forEach(row => {
        tbody += "<tr>" + displayCols.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
      });
      $table.find("tbody").html(tbody);

      $table.DataTable({scrollX: true, pageLength: 10});

      // --- Chart: count per year ---
      // Find which column corresponds to Year
      const yearCol = allHeaders[2]; // assuming column C or adjust accordingly
      const countPerYear = {};

      rawData.forEach(r => {
        const year = r[yearCol];
        if (!year) return;
        if (!countPerYear[year]) countPerYear[year] = 0;
        countPerYear[year]++;
      });

      const years = Object.keys(countPerYear).sort();
      const counts = years.map(y => countPerYear[y]);

      new Chart(document.getElementById("internalChart"), {
        type: "bar",
        data: {
          labels: years,
          datasets: [{
            label: "Internally Funded Projects",
            data: counts,
            backgroundColor: "#1f77b4"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true, precision: 0 } }
        }
      });
    }
  });
});
</script>

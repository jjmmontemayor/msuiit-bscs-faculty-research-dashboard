<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Internally Funded Projects</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="css/style.css">

<!-- JS Libraries -->
<script src="js/libs.js"></script>
<script src="js/sources.js"></script>
</head>
<body>

<h1>Internally Funded Projects</h1>

<div class="chart-container" style="width:90%; max-width:800px; margin: 20px auto;">
  <canvas id="internalChart"></canvas>
</div>

<table id="internalTable" class="display" style="width:90%; margin: 20px auto;">
  <thead><tr></tr></thead>
  <tbody></tbody>
</table>

<script>
window.addEventListener('load', () => {
  Papa.parse(CSV_SOURCES.internals, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const rawData = results.data.filter(r => Object.values(r).some(v => v));
      if (!rawData.length) return;

      // Determine which columns to display (A, C, D, E)
      const allHeaders = Object.keys(rawData[0]);
      const displayCols = [allHeaders[0], allHeaders[2], allHeaders[3], allHeaders[4]];

      // Build table
      const $table = $("#internalTable");
      $table.find("thead").html("<tr>" + displayCols.map(h => `<th>${h}</th>`).join("") + "</tr>");
      let tbody = "";
      rawData.forEach(row => {
        tbody += "<tr>" + displayCols.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
      });
      $table.find("tbody").html(tbody);
      $table.DataTable({scrollX: true, pageLength: 10});

      // Chart: count of projects per year
      // Adjust the year column index if needed
      const yearCol = allHeaders[2]; // Assuming column C is the Year
      const countPerYear = {};

      rawData.forEach(r => {
        const year = r[yearCol];
        if (!year) return;
        if (!countPerYear[year]) countPerYear[year] = 0;
        countPerYear[year]++;
      });

      const years = Object.keys(countPerYear).sort();
      const counts = years.map(y => countPerYear[y]);

      new Chart(document.getElementById("internalChart"), {
        type: "bar",
        data: {
          labels: years,
          datasets: [{
            label: "Internally Funded Projects",
            data: counts,
            backgroundColor: "#1f77b4"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true, precision: 0 } }
        }
      });
    }
  });
});
</script>
</body>
</html>
